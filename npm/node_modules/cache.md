# Cache node_modules

## Situation

* Elastic Beanstalk servers store the source code for node projects/repos in `/tmp/deployment/application`.

* Likewise, they store `node_modules` in `/tmp/deployment/application/node_modules`.

* Every time an environment is deployed (`eb deploy`), Elastic Beanstalk deletes these directories.

## Problems

* Since Elastic Beanstalk deletes the `node_modules` directory during deployment, `npm install` has to reinstall **EVERYTHING**.

* `npm install` is slow.

* Reinstalling **ALL** of the `node_modules` with `npm install` slows down deployment significantly.

* Since `package.json` is changed rarely, most deployments will result in `node_modules` being exactly the same as before.

## Goals

* Only install new or updated `node_modules` when deploying an environment (`eb deploy`).

* Make it simple.

* Make it work.

## Solution

1. Create a new `.ebextensions/node_modules.config` file. Copy and paste this exact content into it:

    ```yaml
    files:
        # Runs right before `npm install` in '.../50npm.sh'
        "/opt/elasticbeanstalk/hooks/appdeploy/pre/49cache_node_modules.sh" :
            mode: "000775"
            owner: root
            group: users
            content: |
                #!/bin/bash

                app="/tmp/deployment/application";
                cache="/var/node_modules";

                mkdir -p "${cache}";
                ln -s "${cache}" "${app}/node_modules";
    ```

2. Deploy.

    ```bash
    eb deploy;
    ```

## Explanation

* The app's `node_modules` directory (`/tmp/deployment/application/node_modules`) links to `/var/node_modules`.

* Because of this link, `npm install` installs to and reads from `/var/node_modules`. *(`npm install` runs in `/opt/elasticbeanstalk/hooks/appdeploy/pre/50npm.sh`, where it calls the npm wrapper `/opt/elasticbeanstalk/containerfiles/ebnode.py`)*

* `/var/node_modules` is not deleted on next deployment.

## Notes

* This hack does **NOT** speed up deployments significantly, maybe only 30 seconds per EC2 instance.

* Technically, the source code is in `/tmp/deployment/application` only temporarily. At the end of the deployment process, Elastic Beanstalk moves it to `/var/app/current`. But since the link to `/var/node_modules` is an absolute path, it will remain intact anywhere on the filesystem.

* Elastic Beanstalk deployments also run `npm rebuild`, which recompiles binaries for any modules which use C++ addons.

    * If your app uses these kinds of modules, the time saved by the hack on this page will be negligible.

    * Even if your app does *not* use these kinds of modules, `npm rebuild` can still take 30 seconds to figure that out.

## Resources
* http://stackoverflow.com/questions/21200251/avoid-rebuilding-node-modules-in-elastic-beanstalk
* https://github.com/kopurando/better-faster-elastic-beanstalk
* https://github.com/kopurando/better-faster-elastic-beanstalk/blob/master/.ebextensions/example_env.config
* https://github.com/kopurando/better-faster-elastic-beanstalk/blob/master/50npm.sh
* http://www.eq8.eu/blogs/29-aws-elasticbeanstalk-deployment-hooks
* http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/customize-containers-ec2.html
